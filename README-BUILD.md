# Build Instructions for Followup Suggester

## Prerequisites

1. **Node.js**: Ensure Node.js 18+ is installed
2. **npm**: Ensure npm is installed (comes with Node.js)

## Setup on New Machine

1. **Clone/Download the project**

2. **Install dependencies**:
   ```powershell
   npm install
   ```

3. **Build the project**:
   ```powershell
   npm run build
   ```

## Build Process Details

The build process now consists of two main steps:

1. **Webpack Bundling** (`webpack --mode production`)
   - Compiles TypeScript files to JavaScript
   - Generates `.d.ts` declaration files for all TypeScript models and services
   - Ensures `CacheEntry.d.ts` and other declaration files are created
   - Bundles JavaScript files for the add-in
   - Processes HTML templates
   - Copies assets

2. **Build Verification** (`npm run verify-build`)
   - Checks that all critical files were generated
   - Reports any missing files

## Available Scripts

- `npm run build` - Full production build with verification
- `npm run clean` - Remove dist folder
- `npm run clean:build` - Clean and build from scratch
- `npm run dev` - Start development server
- `npm run verify-build` - Verify build output without building

## Expected Output

After a successful build, you should see these files in the `dist/` folder:

```
dist/
├── assets/
│   ├── icon-16.png
│   ├── icon-32.png
│   ├── icon-64.png
│   └── icon-80.png
├── commands/
│   ├── commands.d.ts
│   └── commands.d.ts.map
├── models/
│   ├── CacheEntry.d.ts         ← This file should now be present
│   ├── CacheEntry.d.ts.map
│   ├── Configuration.d.ts
│   ├── Configuration.d.ts.map
│   ├── FollowupEmail.d.ts
│   └── FollowupEmail.d.ts.map
├── services/
│   ├── (various .d.ts files)
├── taskpane/
│   ├── taskpane.d.ts
│   └── taskpane.d.ts.map
├── commands.html
├── commands.js
├── taskpane.html
└── taskpane.js
```

## Troubleshooting

### CacheEntry.d.ts is missing

1. **Try a clean build**:
   ```powershell
   npm run clean:build
   ```
   
2. **Verify the source file exists**:
   ```powershell
   dir src\models\CacheEntry.ts
   ```

3. **Check for TypeScript errors**:
   ```powershell
   npx tsc --noEmit
   ```

### Build fails completely

1. **Clean and reinstall**:
   ```powershell
   Remove-Item -Recurse -Force node_modules, dist -ErrorAction SilentlyContinue
   npm install
   npm run build
   ```

2. **Check Node.js version**:
   ```powershell
   node --version
   npm --version
   ```

3. **Verify npm cache**:
   ```powershell
   npm cache clean --force
   npm install
   ```

### Build verification fails

If `npm run verify-build` reports missing files:

1. **Check the specific missing files** in the output
2. **Look for TypeScript compilation errors** in the webpack output
3. **Ensure all dependencies are installed**: `npm install`
4. **Try a clean build**: `npm run clean:build`

## Configuration Files

The build process uses these configuration files:

- `tsconfig.json` - TypeScript compiler configuration
- `webpack.config.js` - Webpack bundling configuration (handles both JS and .d.ts generation)
- `package.json` - Build scripts and dependencies
- `verify-build.js` - Build verification script

## Changes Made to Fix Build Issues

1. **Restored webpack-based TypeScript compilation** for consistent builds
2. **Added explicit build verification** step to catch missing files
3. **Added clean build commands** for troubleshooting
4. **Ensured TypeScript declarations are generated by webpack** using ts-loader
5. **Added cross-platform rimraf** for reliable clean operations

## Why This Approach Works

The key insight is that **TypeScript declaration files are only generated for modules that are part of the dependency graph** starting from the webpack entry points (`taskpane.ts` and `commands.ts`). Since:

- `taskpane.ts` imports `EmailAnalysisService`
- `EmailAnalysisService` imports `CacheService` 
- `CacheService` imports `CacheEntry`

This ensures that `CacheEntry.d.ts` is always generated when the build completes successfully.

This should ensure consistent builds across different machines, including proper generation of the `CacheEntry.d.ts` file.
